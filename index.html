<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Bi·ªÉu ƒë·ªì c·ªôt ngang - D3</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
        }
        
        .bar:hover {
            fill: orange;
        }
        
        .label {
            font-size: 12px;
            fill: black;
        }
        
        .grid line {
            stroke: #ddd;
        }
        /* Tooltip */
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>

<body>
    <h2>Doanh s·ªë b√°n h√†ng theo m·∫∑t h√†ng</h2>
    <svg id="chart"></svg>
    <div id="tooltip" class="tooltip"></div>

    <script>
        const parseNumber = s => {
            if (!s) return 0;
            const cleaned = String(s).trim().replace(/[^\d-]/g, "");
            return cleaned === "" ? 0 : +cleaned;
        };

        d3.csv("data.csv").then(raw => {
            const data = raw.map(d => {
                const MaMH = d["M√£ m·∫∑t h√†ng"] ? d["M√£ m·∫∑t h√†ng"].trim() : "";
                const TenMH = d["T√™n m·∫∑t h√†ng"] ? d["T√™n m·∫∑t h√†ng"].trim() : "";
                const MaNH = d["M√£ nh√≥m h√†ng"] ? d["M√£ nh√≥m h√†ng"].trim() : "";
                const TenNH = d["T√™n nh√≥m h√†ng"] ? d["T√™n nh√≥m h√†ng"].trim() : "";
                const ThanhTien = parseNumber(d["Th√†nh ti·ªÅn"]);
                const SL = parseNumber(d["SL"]); // c·ªôt SL trong file CSV
                return {
                    MaMH,
                    TenMH,
                    MaNH,
                    TenNH,
                    ThanhTien,
                    SL
                };
            });

            // G·ªôp d·ªØ li·ªáu theo M√£ m·∫∑t h√†ng
            const aggMap = d3.rollup(
                data,
                v => ({
                    ThanhTien: d3.sum(v, d => d.ThanhTien),
                    SL: d3.sum(v, d => d.SL)
                }),
                d => `${d.MaMH}|${d.TenMH}|${d.MaNH}|${d.TenNH}`
            );

            const agg = Array.from(aggMap, ([key, val]) => {
                const [MaMH, TenMH, MaNH, TenNH] = key.split("|");
                return {
                    MaMH,
                    TenMH,
                    MaNH,
                    TenNH,
                    ThanhTien: val.ThanhTien,
                    SL: val.SL
                };
            }).sort((a, b) => b.ThanhTien - a.ThanhTien);

            const margin = {
                top: 20,
                right: 250,
                bottom: 40,
                left: 260
            };
            const svgFullWidth = 1100;
            const innerWidth = svgFullWidth - margin.left - margin.right;
            const rowHeight = 28;
            const innerHeight = Math.max(agg.length * rowHeight, 400);

            const svg = d3.select("#chart")
                .attr("width", svgFullWidth)
                .attr("height", innerHeight + margin.top + margin.bottom);

            svg.selectAll("*").remove();

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const y = d3.scaleBand()
                .domain(agg.map(d => `[${d.MaMH}] ${d.TenMH}`))
                .range([0, innerHeight])
                .padding(0.15);

            const xMax = d3.max(agg, d => d.ThanhTien) || 1;
            const x = d3.scaleLinear()
                .domain([0, xMax])
                .range([0, innerWidth]);

            const color = d3.scaleOrdinal(d3.schemeCategory10)
                .domain([...new Set(agg.map(d => d.MaNH))]);

            g.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(x).ticks(6).tickSize(-innerHeight).tickFormat(""));

            // Tooltip
            const tooltip = d3.select("#tooltip");

            g.selectAll(".bar")
                .data(agg)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("y", d => y(`[${d.MaMH}] ${d.TenMH}`))
                .attr("height", y.bandwidth())
                .attr("x", 0)
                .attr("width", d => x(d.ThanhTien))
                .attr("fill", d => color(d.MaNH))
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1)
                        .html(`
                            <b>M·∫∑t h√†ng:</b> [${d.MaMH}] ${d.TenMH}<br>
                            <b>Nh√≥m h√†ng:</b> [${d.MaNH}] ${d.TenNH}<br>
                            <b>Doanh thu:</b> ${d3.format(",.0f")(d.ThanhTien / 1e6)} Tri·ªáu VND<br>
                            <b>S·ªë l∆∞·ª£ng b√°n:</b> ${d.SL} SKUr
                        `);
                })
                .on("mousemove", event => {
                    tooltip.style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.style("opacity", 0);
                });

            g.selectAll(".label")
                .data(agg)
                .enter().append("text")
                .attr("class", "label")
                .attr("x", d => x(d.ThanhTien) + 5)
                .attr("y", d => y(`[${d.MaMH}] ${d.TenMH}`) + y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .text(d => Math.round(d.ThanhTien / 1e6) + " Tri·ªáu");

            g.append("g").call(d3.axisLeft(y));

            g.append("g")
                .attr("transform", `translate(0,${innerHeight})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d => (d / 1e6) + "M"));

            // Legend
            const legend = svg.append("g")
                .attr("transform", `translate(${innerWidth + margin.left + 40},${margin.top})`);

            const categories = d3.groups(agg, d => d.MaNH)
                .map(([MaNH, items]) => ({
                    MaNH,
                    TenNH: items[0].TenNH
                }));

            categories.forEach((cat, i) => {
                const legendRow = legend.append("g")
                    .attr("transform", `translate(0, ${i * 22})`);

                legendRow.append("rect")
                    .attr("width", 15)
                    .attr("height", 15)
                    .attr("fill", color(cat.MaNH));

                legendRow.append("text")
                    .attr("x", 22)
                    .attr("y", 12)
                    .text(`${cat.MaNH} - ${cat.TenNH}`)
                    .style("font-size", "13px")
                    .attr("alignment-baseline", "middle");
            });
        });
    </script>
</body>

</html>



<h2> Doanh s·ªë b√°n h√†ng theo nh√≥m h√†ng</h2>
<svg id="chart-group"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    d3.csv("data.csv").then(raw => {
        const parseNumber = s => {
            if (!s) return 0;
            const cleaned = String(s).trim().replace(/[^\d-]/g, "");
            return cleaned === "" ? 0 : +cleaned;
        };

        // Chu·∫©n h√≥a d·ªØ li·ªáu
        const data = raw.map(d => {
            return {
                MaNH: d["M√£ nh√≥m h√†ng"] ? d["M√£ nh√≥m h√†ng"].trim() : "",
                TenNH: d["T√™n nh√≥m h√†ng"] ? d["T√™n nh√≥m h√†ng"].trim() : "",
                ThanhTien: parseNumber(d["Th√†nh ti·ªÅn"]),
                SL: parseNumber(d["SL"])
            };
        });

        // Gom doanh s·ªë theo Nh√≥m h√†ng
        const aggMap = d3.rollup(
            data,
            v => ({
                totalRevenue: d3.sum(v, d => d.ThanhTien),
                totalSL: d3.sum(v, d => d.SL)
            }),
            d => `${d.MaNH}|${d.TenNH}`
        );

        const agg = Array.from(aggMap, ([key, val]) => {
            const [MaNH, TenNH] = key.split("|");
            return {
                MaNH,
                TenNH,
                Label: `[${MaNH}] ${TenNH}`,
                ThanhTien: val.totalRevenue,
                SL: val.totalSL
            };
        }).sort((a, b) => b.ThanhTien - a.ThanhTien);

        // K√≠ch th∆∞·ªõc
        const margin = {
            top: 20,
            right: 50,
            bottom: 40,
            left: 260
        };
        const svgFullWidth = 900;
        const innerWidth = svgFullWidth - margin.left - margin.right;
        const rowHeight = 30;
        const innerHeight = Math.max(agg.length * rowHeight, 300);

        const svg = d3.select("#chart-group")
            .attr("width", svgFullWidth)
            .attr("height", innerHeight + margin.top + margin.bottom);

        svg.selectAll("*").remove();

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Thang Y (t√™n nh√≥m h√†ng)
        const y = d3.scaleBand()
            .domain(agg.map(d => d.Label))
            .range([0, innerHeight])
            .padding(0.15);

        // Thang X (gi√° tr·ªã)
        const xMax = d3.max(agg, d => d.ThanhTien) || 1;
        const x = d3.scaleLinear()
            .domain([0, xMax])
            .range([0, innerWidth]);

        // Thang m√†u
        const color = d3.scaleOrdinal(d3.schemeCategory10)
            .domain(agg.map(d => d.Label));

        // Tooltip
        const tooltip = d3.select("body").append("div")
            .style("position", "absolute")
            .style("background", "#fff")
            .style("padding", "6px")
            .style("border", "1px solid #ccc")
            .style("border-radius", "4px")
            .style("pointer-events", "none")
            .style("opacity", 0);

        // V·∫Ω c·ªôt
        g.selectAll(".bar")
            .data(agg)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("y", d => y(d.Label))
            .attr("height", y.bandwidth())
            .attr("x", 0)
            .attr("width", d => x(d.ThanhTien))
            .attr("fill", d => color(d.Label))
            .on("mouseover", (event, d) => {
                tooltip.transition().duration(200).style("opacity", 0.95);
                tooltip.html(
                        `<strong>Nh√≥m h√†ng:</strong> [${d.MaNH}] ${d.TenNH}<br>` +
                        `<strong>Doanh thu b√°n:</strong> ${d3.format(",.0f")(d.ThanhTien/1e6)} tri·ªáu VND<br>` +
                        `<strong>S·ªë l∆∞·ª£ng b√°n:</strong> ${d3.format(",")(d.SL)} SKUs`
                    )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 30) + "px");
            })
            .on("mouseout", () => tooltip.transition().duration(200).style("opacity", 0));

        // Nh√£n tr√™n thanh
        g.selectAll(".label")
            .data(agg)
            .enter().append("text")
            .attr("class", "label")
            .attr("x", d => x(d.ThanhTien) + 5)
            .attr("y", d => y(d.Label) + y.bandwidth() / 2)
            .attr("dy", "0.35em")
            .text(d => d3.format(",.0f")(d.ThanhTien / 1e6) + " Tri·ªáu VND");

        // Tr·ª•c Y
        g.append("g").call(d3.axisLeft(y));

        // Tr·ª•c X
        g.append("g")
            .attr("transform", `translate(0,${innerHeight})`)
            .call(d3.axisBottom(x).ticks(6).tickFormat(d => (d / 1e6) + "M"));
    });
</script>





</script>
<h2>Doanh s·ªë b√°n h√†ng theo th√°ng</h2>
<svg id="chart-month"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
    .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.75);
        color: #fff;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 13px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
    }
</style>
<div id="tooltip" class="tooltip"></div>

<script>
    d3.csv("data.csv").then(raw => {
        const parseNumber = s => {
            if (!s) return 0;
            const cleaned = String(s).replace(/[^0-9]/g, "");
            return cleaned ? +cleaned : 0;
        };

        // Chu·∫©n h√≥a d·ªØ li·ªáu
        const data = raw.map(d => {
            const date = d["Th·ªùi gian t·∫°o ƒë∆°n"] ? new Date(d["Th·ªùi gian t·∫°o ƒë∆°n"]) : null;
            const month = date ? date.getMonth() + 1 : null;
            return {
                month,
                ThanhTien: parseNumber(d["Th√†nh ti·ªÅn"]),
                SL: parseNumber(d["SL"])
            };
        }).filter(d => d.month !== null);

        // T√≠nh t·ªïng doanh thu v√† SL theo th√°ng
        const aggMap = d3.rollup(
            data,
            v => ({
                ThanhTien: d3.sum(v, d => d.ThanhTien),
                SL: d3.sum(v, d => d.SL)
            }),
            d => d.month
        );

        // ƒê·ªß 12 th√°ng
        const months = Array.from({
            length: 12
        }, (_, i) => i + 1);

        const agg = months.map(m => {
            const val = aggMap.get(m) || {
                ThanhTien: 0,
                SL: 0
            };
            return {
                month: m,
                label: "Th√°ng " + String(m).padStart(2, "0"),
                ThanhTien: val.ThanhTien,
                SL: val.SL
            };
        });



        // K√≠ch th∆∞·ªõc SVG
        const margin = {
            top: 20,
            right: 30,
            bottom: 50,
            left: 80
        };
        const width = 900 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select("#chart-month")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        svg.selectAll("*").remove();

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Tr·ª•c X
        const x = d3.scaleBand()
            .domain(agg.map(d => d.label))
            .range([0, width])
            .padding(0.2);

        // Tr·ª•c Y
        const yMax = d3.max(agg, d => d.ThanhTien) || 1;
        const y = d3.scaleLinear()
            .domain([0, yMax])
            .range([height, 0])
            .nice();

        const color = d3.scaleOrdinal(d3.schemeCategory10)
            .domain(agg.map(d => d.label));

        const tooltip = d3.select("#tooltip");

        // V·∫Ω c·ªôt
        g.selectAll(".bar")
            .data(agg)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.label))
            .attr("y", d => y(d.ThanhTien))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.ThanhTien))
            .attr("fill", d => color(d.label))
            .on("mouseover", (event, d) => {
                tooltip.style("opacity", 1)
                    .html(`
                        <b>Th√°ng:</b> ${d.label}<br>
                        <b>Doanh s·ªë b√°n:</b> ${d3.format(",.0f")(d.ThanhTien/1e6)} Tri·ªáu VND<br>
                        <b>S·ªë l∆∞·ª£ng b√°n:</b> ${d.SL} SKUs
                    `);
            })
            .on("mousemove", event => {
                tooltip.style("left", (event.pageX + 15) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", () => tooltip.style("opacity", 0));

        // Nh√£n tr√™n c·ªôt
        g.selectAll(".label")
            .data(agg)
            .enter().append("text")
            .attr("x", d => x(d.label) + x.bandwidth() / 2)
            .attr("y", d => y(d.ThanhTien) - 5)
            .attr("text-anchor", "middle")
            .text(d => d3.format(",.0f")(d.ThanhTien / 1e6) + " Tri·ªáu");

        // Tr·ª•c X
        g.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x));

        // Tr·ª•c Y
        g.append("g")
            .call(d3.axisLeft(y).ticks(6).tickFormat(d => (d / 1e6) + "M"));
    });
</script>










<h2>Doanh s·ªë trung b√¨nh theo ng√†y trong tu·∫ßn</h2>
<svg id="chart-weekday"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    d3.csv("data.csv").then(raw => {
        const parseNumber = s => {
            if (!s) return 0;
            const cleaned = String(s).replace(/[^0-9]/g, "");
            return cleaned ? +cleaned : 0;
        };

        // L·∫•y ng√†y yyyy-mm-dd t·ª´ "Th·ªùi gian t·∫°o ƒë∆°n"
        const data = raw.map(d => {
            const date = d["Th·ªùi gian t·∫°o ƒë∆°n"] ? new Date(d["Th·ªùi gian t·∫°o ƒë∆°n"].trim()) : null;
            const dayStr = date ? date.toISOString().slice(0, 10) : null;
            return {
                dayStr,
                ThanhTien: parseNumber(d["Th√†nh ti·ªÅn"]),
                SL: parseNumber(d["SL"]) // s·ªë l∆∞·ª£ng
            };
        }).filter(d => d.dayStr !== null);

        // T·ªïng doanh thu & SL theo ng√†y
        const totalByDay = d3.rollup(
            data,
            v => ({
                ThanhTien: d3.sum(v, d => d.ThanhTien),
                SL: d3.sum(v, d => d.SL)
            }),
            d => d.dayStr
        );

        // Nh√≥m theo ng√†y trong tu·∫ßn
        const weekdayMap = new Map();
        totalByDay.forEach((obj, dayStr) => {
            const weekday = new Date(dayStr).getDay(); // 0 = CN
            if (!weekdayMap.has(weekday)) weekdayMap.set(weekday, []);
            weekdayMap.get(weekday).push(obj);
        });

        // T√≠nh trung b√¨nh theo ng√†y trong tu·∫ßn
        const weekdayLabels = ["Th·ª© 2", "Th·ª© 3", "Th·ª© 4", "Th·ª© 5", "Th·ª© 6", "Th·ª© 7", "Ch·ªß nh·∫≠t"];
        const weekdayAgg = weekdayLabels.map((label, i) => {
            const weekdayNum = (i + 1) % 7; // 0 = CN
            const vals = weekdayMap.get(weekdayNum) || [];
            const avgThanhTien = d3.mean(vals, d => d.ThanhTien) || 0;
            const avgSL = d3.mean(vals, d => d.SL) || 0;
            return {
                label,
                avgThanhTien,
                avgSL
            };
        });

        const margin = {
            top: 20,
            right: 30,
            bottom: 50,
            left: 100
        };
        const width = 900 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select("#chart-weekday")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        svg.selectAll("*").remove();

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Tr·ª•c X
        const x = d3.scaleBand()
            .domain(weekdayAgg.map(d => d.label))
            .range([0, width])
            .padding(0.2);

        // Tr·ª•c Y
        const yMax = d3.max(weekdayAgg, d => d.avgThanhTien) || 1;
        const y = d3.scaleLinear()
            .domain([0, yMax])
            .range([height, 0])
            .nice();

        const color = d3.scaleOrdinal(d3.schemeCategory10)
            .domain(weekdayAgg.map(d => d.label));

        // Tooltip
        // Tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("position", "absolute")
            .style("background", "white")
            .style("color", "black") // üëâ th√™m m√†u ch·ªØ
            .style("border", "1px solid gray")
            .style("padding", "6px")
            .style("border-radius", "4px")
            .style("box-shadow", "0px 0px 5px rgba(0,0,0,0.3)")
            .style("pointer-events", "none")
            .style("opacity", 0);

        // V·∫Ω c·ªôt
        g.selectAll(".bar")
            .data(weekdayAgg)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.label))
            .attr("y", d => y(d.avgThanhTien))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.avgThanhTien))
            .attr("fill", d => color(d.label))
            .on("mouseover", function(event, d) {
                tooltip.transition().duration(200).style("opacity", 0.95);
                tooltip.html(
                        `<strong>${d.label}</strong><br/>
                     Doanh thu TB: ${d3.format(",")(Math.round(d.avgThanhTien))} VND<br/>
                     SL b√°n TB: ${d3.format(",")(Math.round(d.avgSL))} SKUs`
                    )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                tooltip.transition().duration(300).style("opacity", 0);
            });

        // Nh√£n tr√™n c·ªôt (s·ªë th·∫≠t + VND)
        g.selectAll(".label")
            .data(weekdayAgg)
            .enter().append("text")
            .attr("x", d => x(d.label) + x.bandwidth() / 2)
            .attr("y", d => y(d.avgThanhTien) - 5)
            .attr("text-anchor", "middle")
            .attr("font-size", "11px")
            .text(d => d3.format(",")(Math.round(d.avgThanhTien)) + " VND");

        // Tr·ª•c X
        g.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x));

        // Tr·ª•c Y hi·ªÉn th·ªã tri·ªáu (M), KH√îNG VND
        g.append("g")
            .call(
                d3.axisLeft(y)
                .ticks(6)
                .tickFormat(d => d3.format(",.0f")(d / 1e6) + "M")
            );
    });
</script>







<h2>Doanh s·ªë trung b√¨nh theo ng√†y trong th√°ng</h2>
<svg id="chart-day"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    d3.csv("data.csv").then(raw => {
        const parseNumber = s => {
            if (!s) return 0;
            const cleaned = String(s).replace(/[^0-9]/g, "");
            return cleaned ? +cleaned : 0;
        };

        // Nh√≥m theo ng√†y th·ª±c t·∫ø (doanh thu + SL)
        const totalByDayMap = d3.rollup(
            raw.filter(d => d["Th·ªùi gian t·∫°o ƒë∆°n"]),
            v => ({
                ThanhTien: d3.sum(v, d => parseNumber(d["Th√†nh ti·ªÅn"])),
                SL: d3.sum(v, d => parseNumber(d["SL"]))
            }),
            d => new Date(d["Th·ªùi gian t·∫°o ƒë∆°n"].trim()).toISOString().slice(0, 10)
        );

        // T·∫°o m·∫£ng ng√†y 01 -> 31
        const dayAgg = Array.from({
            length: 31
        }, (_, i) => {
            const day = i + 1;
            const valuesOfDay = Array.from(totalByDayMap.entries())
                .filter(([dateStr, _]) => new Date(dateStr).getDate() === day)
                .map(([_, obj]) => obj);

            const avgThanhTien = valuesOfDay.length ? d3.mean(valuesOfDay, d => d.ThanhTien) : 0;
            const avgSL = valuesOfDay.length ? d3.mean(valuesOfDay, d => d.SL) : 0;

            return {
                day,
                label: "Ng√†y " + String(day).padStart(2, "0"),
                avgThanhTien,
                avgSL
            };
        });

        const margin = {
            top: 20,
            right: 30,
            bottom: 50,
            left: 80
        };
        const width = 1200 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select("#chart-day")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        svg.selectAll("*").remove();

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Tr·ª•c X
        const x = d3.scaleBand()
            .domain(dayAgg.map(d => d.label))
            .range([0, width])
            .padding(0.2);

        // Tr·ª•c Y
        const yMax = d3.max(dayAgg, d => d.avgThanhTien) || 1;
        const y = d3.scaleLinear()
            .domain([0, yMax])
            .range([height, 0])
            .nice();

        const color = d3.scaleOrdinal(d3.schemeCategory10)
            .domain(dayAgg.map(d => d.label));

        // Tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("position", "absolute")
            .style("background", "white")
            .style("color", "black")
            .style("border", "1px solid gray")
            .style("padding", "6px")
            .style("border-radius", "4px")
            .style("box-shadow", "0px 0px 5px rgba(0,0,0,0.3)")
            .style("pointer-events", "none")
            .style("opacity", 0);

        // V·∫Ω c·ªôt
        g.selectAll(".bar")
            .data(dayAgg)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.label))
            .attr("y", d => y(d.avgThanhTien))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.avgThanhTien))
            .attr("fill", d => color(d.label))
            .on("mouseover", function(event, d) {
                tooltip.transition().duration(200).style("opacity", 0.95);
                tooltip.html(
                        `<strong>${d.label}</strong><br/>
                     Doanh s·ªë b√°n TB: ${d3.format(",.1f")(d.avgThanhTien / 1e6)} tr<br/>
                     SL b√°n TB: ${d3.format(",")(Math.round(d.avgSL))} SKUs`
                    )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                tooltip.transition().duration(300).style("opacity", 0);
            });

        // Nh√£n tr√™n c·ªôt (hi·ªán d·∫°ng 12,7 tr)
        g.selectAll(".label")
            .data(dayAgg)
            .enter().append("text")
            .attr("x", d => x(d.label) + x.bandwidth() / 2)
            .attr("y", d => y(d.avgThanhTien) - 5)
            .attr("text-anchor", "middle")
            .attr("font-size", "11px")
            .text(d => d3.format(",.1f")(d.avgThanhTien / 1e6) + " tr");

        // Tr·ª•c X
        g.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "rotate(-45)")
            .style("text-anchor", "end");

        // Tr·ª•c Y (tri·ªáu VND = M)
        g.append("g")
            .call(
                d3.axisLeft(y)
                .ticks(6)
                .tickFormat(d => d3.format(",.0f")(d / 1e6) + "M")
            );
    });
</script>


<h2>Doanh s·ªë trung b√¨nh theo khung gi·ªù th·ª±c t·∫ø</h2>
<svg id="chart-hour"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    d3.csv("data.csv").then(raw => {
        const parseNumber = s => {
            if (!s) return 0;
            const cleaned = String(s).replace(/[^0-9]/g, "");
            return cleaned ? +cleaned : 0;
        };

        // Chu·∫©n h√≥a d·ªØ li·ªáu
        const dataByHour = raw
            .filter(d => d["Th·ªùi gian t·∫°o ƒë∆°n"])
            .map(d => {
                const dt = new Date(d["Th·ªùi gian t·∫°o ƒë∆°n"].trim());
                const dateStr = dt.toISOString().slice(0, 10);
                const hour = dt.getHours();
                const hourStr = hour.toString();
                const KhungGio = `${hourStr}h00 - ${hourStr}h59`;
                return {
                    dateStr,
                    KhungGio,
                    ThanhTien: parseNumber(d["Th√†nh ti·ªÅn"]),
                    SoLuong: parseNumber(d["S·ªë l∆∞·ª£ng"] || "1")
                };
            });

        // T·ªïng theo ng√†y + khung gi·ªù
        const totalByDateHour = d3.rollup(
            dataByHour,
            v => ({
                sumTien: d3.sum(v, d => d.ThanhTien),
                sumSL: d3.sum(v, d => d.SoLuong)
            }),
            d => `${d.dateStr}-${d.KhungGio}`
        );

        // Trung b√¨nh theo khung gi·ªù
        const hourAgg = Array.from(
            d3.rollup(
                Array.from(totalByDateHour.entries()).map(([key, val]) => {
                    const khungGio = key.slice(11);
                    return {
                        KhungGio: khungGio,
                        sumTien: val.sumTien,
                        sumSL: val.sumSL
                    };
                }),
                v => ({
                    avgTien: d3.mean(v, d => d.sumTien),
                    avgSL: d3.mean(v, d => d.sumSL)
                }),
                d => d.KhungGio
            ),
            ([KhungGio, obj]) => ({
                KhungGio,
                avg: obj.avgTien,
                avgSL: obj.avgSL
            })
        ).sort((a, b) => {
            const getHour = s => +s.split("h")[0];
            return getHour(a.KhungGio) - getHour(b.KhungGio);
        });

        const margin = {
            top: 20,
            right: 30,
            bottom: 70,
            left: 80
        };
        const width = 1200 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select("#chart-hour")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        svg.selectAll("*").remove();

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleBand()
            .domain(hourAgg.map(d => d.KhungGio))
            .range([0, width])
            .padding(0.2);

        const yMax = d3.max(hourAgg, d => d.avg) || 1;
        const y = d3.scaleLinear()
            .domain([0, yMax])
            .range([height, 0])
            .nice();

        const color = d3.scaleOrdinal(d3.schemeCategory10)
            .domain(hourAgg.map(d => d.KhungGio));

        // Tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("position", "absolute")
            .style("background", "white")
            .style("color", "black")
            .style("border", "1px solid gray")
            .style("padding", "6px")
            .style("border-radius", "4px")
            .style("box-shadow", "0px 0px 5px rgba(0,0,0,0.3)")
            .style("pointer-events", "none")
            .style("opacity", 0);

        // V·∫Ω c·ªôt
        g.selectAll(".bar")
            .data(hourAgg)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.KhungGio))
            .attr("y", d => y(d.avg))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.avg))
            .attr("fill", d => color(d.KhungGio))
            .on("mouseover", function(event, d) {
                tooltip.transition().duration(200).style("opacity", 0.95);
                tooltip.html(
                        `<strong>${d.KhungGio}</strong><br/>
                 Doanh thu TB: ${d3.format(",")(Math.ceil(d.avg))} VND<br/>
                 S·ªë l∆∞·ª£ng TB: ${d3.format(",.0f")(Math.ceil(d.avgSL))} SP`
                    )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                tooltip.transition().duration(300).style("opacity", 0);
            });

        // Nh√£n tr√™n c·ªôt
        g.selectAll(".label")
            .data(hourAgg)
            .enter().append("text")
            .attr("x", d => x(d.KhungGio) + x.bandwidth() / 2)
            .attr("y", d => y(d.avg) - 5)
            .attr("text-anchor", "middle")
            .attr("font-size", "12px")
            .text(d => d3.format(",")(Math.ceil(d.avg)) + " VND");

        // Tr·ª•c Y hi·ªÉn th·ªã ngh√¨n (K)
        g.append("g")
            .call(d3.axisLeft(y)
                .ticks(6)
                .tickFormat(d => d3.format(",")(Math.ceil(d / 1e3)) + "K")
            );

        // Tr·ª•c X
        g.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "rotate(-45)")
            .style("text-anchor", "end");
    });
</script>








<h2>X√°c su·∫•t b√°n h√†ng theo nh√≥m h√†ng</h2>
<svg id="chart-horizontal"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    d3.csv("data.csv").then(raw => {
        // Chu·∫©n h√≥a d·ªØ li·ªáu
        raw.forEach(d => {
            d.NhomHang_Ten = d["M√£ nh√≥m h√†ng"] + " - " + d["T√™n nh√≥m h√†ng"];
        });

        // T√≠nh s·ªë ƒë∆°n h√†ng cho t·ª´ng nh√≥m
        const groupDataMap = d3.rollup(
            raw,
            v => ({
                orderCount: new Set(v.map(d => d["M√£ ƒë∆°n h√†ng"])).size
            }),
            d => d.NhomHang_Ten
        );

        // T·ªïng s·ªë ƒë∆°n h√†ng trong b·∫£ng
        const totalOrders = new Set(raw.map(d => d["M√£ ƒë∆°n h√†ng"])).size;

        // Chuy·ªÉn th√†nh m·∫£ng cho D3
        const data = Array.from(groupDataMap.entries()).map(([group, val]) => ({
            group,
            orderCount: val.orderCount,
            probability: val.orderCount / totalOrders
        })).sort((a, b) => b.probability - a.probability); // s·∫Øp x·∫øp gi·∫£m d·∫ßn

        const margin = {
            top: 50,
            right: 30,
            bottom: 50,
            left: 200
        };
        const width = 900 - margin.left - margin.right;
        const height = data.length * 30; // chi·ªÅu cao t√πy thu·ªôc s·ªë nh√≥m

        const svg = d3.select("#chart-horizontal")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        svg.selectAll("*").remove();

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Tr·ª•c X (t·ª∑ l·ªá)
        const x = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.probability)])
            .range([0, width])
            .nice();

        // Tr·ª•c Y (nh√≥m h√†ng)
        const y = d3.scaleBand()
            .domain(data.map(d => d.group))
            .range([0, height])
            .padding(0.2);

        const color = d3.scaleOrdinal(d3.schemeCategory10)
            .domain(data.map(d => d.group));

        // Tr·ª•c X
        // Tr·ª•c X ·ªü d∆∞·ªõi
        g.append("g")
            .attr("transform", `translate(0,${height})`) // di chuy·ªÉn xu·ªëng ƒë√°y chart
            .call(d3.axisBottom(x).tickFormat(d3.format(".0%")));

        // Tr·ª•c Y
        g.append("g")
            .call(d3.axisLeft(y));

        // Tooltip
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("position", "absolute")
            .style("background", "white")
            .style("color", "black")
            .style("border", "1px solid gray")
            .style("padding", "6px")
            .style("border-radius", "4px")
            .style("pointer-events", "none")
            .style("opacity", 0);

        // V·∫Ω thanh ngang
        g.selectAll(".bar")
            .data(data)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("y", d => y(d.group))
            .attr("height", y.bandwidth())
            .attr("x", 0)
            .attr("width", d => x(d.probability))
            .attr("fill", d => color(d.group))
            .on("mouseover", function(event, d) {
                tooltip.transition().duration(200).style("opacity", 0.95);
                tooltip.html(
                        `<strong>Nh√≥m h√†ng: ${d.group}</strong><br/>
                 SL ƒë∆°n b√°n: ${d.orderCount}<br/>
                 X√°c su·∫•t b√°n: ${(d.probability*100).toFixed(1)}%`
                    )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 30) + "px");
            })
            .on("mouseout", () => tooltip.transition().duration(200).style("opacity", 0));

        // Nh√£n tr√™n thanh (x√°c su·∫•t)
        g.selectAll(".label")
            .data(data)
            .enter().append("text")
            .attr("x", d => x(d.probability) + 5)
            .attr("y", d => y(d.group) + y.bandwidth() / 2)
            .attr("dy", "0.35em")
            .attr("font-size", "12px")
            .text(d => (d.probability * 100).toFixed(1) + "%");
    });
</script>








<h2>X√°c su·∫•t b√°n h√†ng theo nh√≥m h√†ng theo th√°ng</h2>
<svg id="chart-line-prob"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    d3.csv("data.csv").then(raw => {
        // H√†m parse th√°ng t·ª´ c·ªôt "Th·ªùi gian t·∫°o ƒë∆°n"
        const parseMonth = d => {
            if (!d) return null;
            const dt = new Date(d);
            return isNaN(dt) ? null : dt.getMonth() + 1; // 1..12
        };

        // Chu·∫©n h√≥a d·ªØ li·ªáu
        raw.forEach(d => {
            const m = parseMonth(d["Th·ªùi gian t·∫°o ƒë∆°n"]);
            d.Thang_Ten = m ? "Th√°ng " + String(m).padStart(2, "0") : null;
            d.NhomHang_Ten = d["M√£ nh√≥m h√†ng"] + " - " + d["T√™n nh√≥m h√†ng"];
        });

        // L·ªçc d·ªØ li·ªáu h·ª£p l·ªá
        const cleanData = raw.filter(d => d.Thang_Ten !== null);

        // Danh s√°ch th√°ng (sort theo s·ªë)
        const months = Array.from(new Set(cleanData.map(d => d.Thang_Ten)))
            .sort((a, b) => +a.replace(/\D/g, "") - +b.replace(/\D/g, ""));

        // Danh s√°ch nh√≥m h√†ng
        const groups = Array.from(new Set(cleanData.map(d => d.NhomHang_Ten)));

        // Nh√≥m d·ªØ li·ªáu theo th√°ng, t√≠nh s·ªë ƒë∆°n v√† t·ªïng SL
        const dataByMonth = d3.rollup(
            cleanData,
            v => {
                const totalOrdersMonth = new Set(v.map(d => d["M√£ ƒë∆°n h√†ng"])).size;
                const groupMap = d3.rollup(
                    v,
                    g => ({
                        orderCount: new Set(g.map(d => d["M√£ ƒë∆°n h√†ng"])).size, // s·ªë ƒë∆°n
                        totalSL: d3.sum(g, d => +d["SL"] || 0) // t·ªïng SL
                    }),
                    d => d.NhomHang_Ten
                );
                return {
                    totalOrdersMonth,
                    groupMap
                };
            },
            d => d.Thang_Ten
        );

        // Chuy·ªÉn d·ªØ li·ªáu th√†nh d·∫°ng line chart
        const lineData = groups.map(group => {
            const values = months.map(month => {
                const monthData = dataByMonth.get(month);
                const groupData = monthData ? monthData.groupMap.get(group) : null;
                const probability = monthData && monthData.totalOrdersMonth ?
                    (groupData ? groupData.orderCount : 0) / monthData.totalOrdersMonth :
                    0;
                return {
                    month,
                    probability,
                    count: groupData ? groupData.orderCount : 0,
                    totalSL: groupData ? groupData.totalSL : 0
                };
            });
            return {
                group,
                values
            };
        });

        // V·∫Ω chart
        const margin = {
            top: 50,
            right: 200,
            bottom: 50,
            left: 70
        };
        const width = 900 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        const svg = d3.select("#chart-line-prob")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        svg.selectAll("*").remove();

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Tr·ª•c X
        const x = d3.scaleBand()
            .domain(months)
            .range([0, width])
            .padding(0.1);

        // Tr·ª•c Y
        const y = d3.scaleLinear()
            .domain([0, d3.max(lineData, d => d3.max(d.values, v => v.probability)) || 1])
            .range([height, 0])
            .nice();

        const color = d3.scaleOrdinal(d3.schemeCategory10).domain(groups);

        // V·∫Ω tr·ª•c
        g.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x));

        g.append("g")
            .call(d3.axisLeft(y).tickFormat(d => (d * 100).toFixed(0) + "%"));

        // Line generator
        const line = d3.line()
            .x(d => x(d.month) + x.bandwidth() / 2)
            .y(d => y(d.probability));

        // Tooltip
        const tooltip = d3.select("body").append("div")
            .style("position", "absolute")
            .style("background", "#fff")
            .style("padding", "6px")
            .style("border", "1px solid #ccc")
            .style("border-radius", "4px")
            .style("pointer-events", "none")
            .style("opacity", 0);

        // V·∫Ω ƒë∆∞·ªùng v√† ƒëi·ªÉm
        lineData.forEach(d => {
            g.append("path")
                .datum(d.values)
                .attr("fill", "none")
                .attr("stroke", color(d.group))
                .attr("stroke-width", 2)
                .attr("d", line);

            g.selectAll(".dot-" + d.group.replace(/\s+/g, ""))
                .data(d.values)
                .enter().append("circle")
                .attr("cx", v => x(v.month) + x.bandwidth() / 2)
                .attr("cy", v => y(v.probability))
                .attr("r", 4)
                .attr("fill", color(d.group))
                .on("mouseover", (event, v) => {
                    tooltip.transition().duration(200).style("opacity", 0.95);
                    tooltip.html(
                            `<strong>Nh√≥m h√†ng: ${d.group}</strong><br>` +
                            `Th√°ng: ${v.month}<br>` +
                            `SL ƒë∆°n b√°n: ${v.totalSL}<br>` +
                            `X√°c su·∫•t b√°n: ${(v.probability * 100).toFixed(1)}%`
                        )
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 30) + "px");
                })
                .on("mouseout", () => tooltip.transition().duration(200).style("opacity", 0));
        });

        // Legend
        const legend = svg.append("g")
            .attr("transform", `translate(${width + margin.left + 20}, ${margin.top})`);

        lineData.forEach((d, i) => {
            const gLegend = legend.append("g").attr("transform", `translate(0, ${i * 20})`);
            gLegend.append("rect")
                .attr("width", 12)
                .attr("height", 12)
                .attr("fill", color(d.group));
            gLegend.append("text")
                .attr("x", 18)
                .attr("y", 12)
                .attr("font-size", "12px")
                .text(d.group);
        });
    });
</script>




<h2>X√°c su·∫•t b√°n h√†ng c·ªßa m·∫∑t h√†ng theo nh√≥m h√†ng </h2>
<div id="charts-container" style="display:flex; flex-wrap:wrap; gap:30px;"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    d3.csv("data.csv").then(raw => {
        // Chu·∫©n h√≥a d·ªØ li·ªáu
        raw.forEach(d => {
            d.NhomHang = d["M√£ nh√≥m h√†ng"] + " - " + d["T√™n nh√≥m h√†ng"];
            d.SP = d["M√£ m·∫∑t h√†ng"] + " - " + d["T√™n m·∫∑t h√†ng"];
        });

        // Nh√≥m theo nh√≥m h√†ng
        const groups = Array.from(d3.group(raw, d => d.NhomHang), ([nhom, items]) => {
            const totalOrders = new Set(items.map(d => d["M√£ ƒë∆°n h√†ng"])).size;
            const spData = Array.from(d3.rollup(
                items,
                v => ({
                    orderCount: new Set(v.map(d => d["M√£ ƒë∆°n h√†ng"])).size
                }),
                d => d.SP
            ), ([sp, val]) => ({
                sp,
                orderCount: val.orderCount,
                probability: val.orderCount / totalOrders
            })).sort((a, b) => b.probability - a.probability); // s·∫Øp x·∫øp theo x√°c su·∫•t
            return {
                nhom,
                spData
            };
        });

        const chartWidth = 600;
        const chartHeight = 300;
        const margin = {
            top: 30,
            right: 20,
            bottom: 50,
            left: 180
        };

        const color = d3.scaleOrdinal(d3.schemeCategory10)
            .domain(Array.from(new Set(raw.map(d => d.SP))));

        const container = d3.select("#charts-container");

        groups.forEach(group => {
            const svg = container.append("svg")
                .attr("width", chartWidth)
                .attr("height", chartHeight);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const width = chartWidth - margin.left - margin.right;
            const height = chartHeight - margin.top - margin.bottom;

            const y = d3.scaleBand()
                .domain(group.spData.map(d => d.sp))
                .range([0, height])
                .padding(0.1);

            const x = d3.scaleLinear()
                .domain([0, d3.max(group.spData, d => d.probability)])
                .range([0, width])
                .nice();

            // Tr·ª•c X
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d3.format(".0%")));

            // Tr·ª•c Y
            g.append("g")
                .call(d3.axisLeft(y));

            // Tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("background", "white")
                .style("color", "black")
                .style("border", "1px solid gray")
                .style("padding", "6px")
                .style("border-radius", "4px")
                .style("pointer-events", "none")
                .style("opacity", 0);

            // V·∫Ω c·ªôt ngang
            g.selectAll(".bar")
                .data(group.spData)
                .enter().append("rect")
                .attr("y", d => y(d.sp))
                .attr("x", 0)
                .attr("height", y.bandwidth())
                .attr("width", d => x(d.probability))
                .attr("fill", d => color(d.sp))
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", 0.95);
                    tooltip.html(
                            `<strong>Nh√≥m h√†ng: ${group.nhom}</strong><br/>
                     SP: ${d.sp}<br/>
                     SL ƒë∆°n b√°n: ${d.orderCount}<br/>
                     X√°c su·∫•t: ${(d.probability*100).toFixed(1)}%`
                        )
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 30) + "px");
                })
                .on("mouseout", () => tooltip.transition().duration(200).style("opacity", 0));

            // ‚úÖ Th√™m label hi·ªÉn th·ªã x√°c su·∫•t tr√™n m·ªói thanh
            g.selectAll(".label")
                .data(group.spData)
                .enter().append("text")
                .attr("class", "label")
                .attr("x", d => x(d.probability) + 5) // ƒë·∫∑t b√™n ph·∫£i thanh
                .attr("y", d => y(d.sp) + y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .attr("font-size", "12px")
                .text(d => (d.probability * 100).toFixed(1) + "%");

            // Ti√™u ƒë·ªÅ nh√≥m
            svg.append("text")
                .attr("x", chartWidth / 2)
                .attr("y", margin.top / 2)
                .attr("text-anchor", "middle")
                .attr("font-size", "14px")
                .attr("font-weight", "bold")
                .text(group.nhom);
        });
    });
</script>




<h2>X√°c su·∫•t b√°n h√†ng c·ªßa m·∫∑t h√†ng theo Nh√≥m h√†ng trong t·ª´ng Th√°ng</h2>
<div id="charts-monthly" style="display:flex; flex-wrap:wrap; gap:30px;"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    d3.csv("data.csv").then(raw => {
        raw.forEach(d => {
            const dt = new Date(d["Th·ªùi gian t·∫°o ƒë∆°n"]);
            const month = dt.getMonth() + 1;
            d.Thang_Ten = "Th√°ng " + String(month).padStart(2, "0");
            d.NhomHang = d["M√£ nh√≥m h√†ng"] + " - " + d["T√™n nh√≥m h√†ng"];
            d.SP = d["M√£ m·∫∑t h√†ng"] + " - " + d["T√™n m·∫∑t h√†ng"];
        });

        const months = Array.from(new Set(raw.map(d => d.Thang_Ten))).sort();
        const groups = Array.from(d3.group(raw, d => d.NhomHang));

        const container = d3.select("#charts-monthly");
        const chartWidth = 700;
        const chartHeight = 300;
        const margin = {
            top: 30,
            right: 30,
            bottom: 70, // tƒÉng ch·ªó ƒë·ªÉ legend
            left: 80
        };

        groups.forEach(([nhom, items]) => {
            const spMonthMap = d3.rollup(
                items,
                v => new Set(v.map(d => d["M√£ ƒë∆°n h√†ng"])).size,
                d => d.SP,
                d => d.Thang_Ten
            );
            const nhomMonthMap = d3.rollup(
                items,
                v => new Set(v.map(d => d["M√£ ƒë∆°n h√†ng"])).size,
                d => d.Thang_Ten
            );

            const spLines = Array.from(spMonthMap, ([sp, monthMap]) => {
                const values = months.map(m => {
                    const spCount = monthMap.get(m) || 0;
                    const nhomCount = nhomMonthMap.get(m) || 1;
                    return {
                        month: m,
                        probability: spCount / nhomCount,
                        orderCount: spCount
                    };
                });
                return {
                    sp,
                    values
                };
            });

            const svg = container.append("svg")
                .attr("width", chartWidth)
                .attr("height", chartHeight);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const width = chartWidth - margin.left - margin.right;
            const height = chartHeight - margin.top - margin.bottom;

            const x = d3.scaleBand()
                .domain(months)
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(spLines, d => d3.max(d.values, v => v.probability))])
                .range([height, 0])
                .nice();

            const color = d3.scaleOrdinal(d3.schemeCategory10)
                .domain(spLines.map(d => d.sp));

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            g.append("g")
                .call(d3.axisLeft(y).tickFormat(d3.format(".0%")));

            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("background", "white")
                .style("color", "black")
                .style("border", "1px solid gray")
                .style("padding", "6px")
                .style("border-radius", "4px")
                .style("pointer-events", "none")
                .style("opacity", 0);

            const line = d3.line()
                .x(d => x(d.month) + x.bandwidth() / 2)
                .y(d => y(d.probability));

            spLines.forEach(d => {
                g.append("path")
                    .datum(d.values)
                    .attr("fill", "none")
                    .attr("stroke", color(d.sp))
                    .attr("stroke-width", 2)
                    .attr("d", line);

                g.selectAll(".dot-" + d.sp.replace(/\s+/g, ""))
                    .data(d.values)
                    .enter().append("circle")
                    .attr("cx", v => x(v.month) + x.bandwidth() / 2)
                    .attr("cy", v => y(v.probability))
                    .attr("r", 3)
                    .attr("fill", color(d.sp))
                    .on("mouseover", (event, v) => {
                        tooltip.transition().duration(200).style("opacity", 0.95);
                        tooltip.html(
                                `<strong>Nh√≥m h√†ng: ${nhom}</strong><br/>
                             SP: ${d.sp}<br/>
                             SL ƒë∆°n b√°n: ${v.orderCount}<br/>
                             X√°c su·∫•t: ${(v.probability*100).toFixed(1)}%`
                            )
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 30) + "px");
                    })
                    .on("mouseout", () => tooltip.transition().duration(200).style("opacity", 0));
            });

            // Ti√™u ƒë·ªÅ nh√≥m h√†ng
            svg.append("text")
                .attr("x", chartWidth / 2)
                .attr("y", margin.top / 2)
                .attr("text-anchor", "middle")
                .attr("font-size", "14px")
                .attr("font-weight", "bold")
                .text(nhom);

            // ‚úÖ Legend d∆∞·ªõi bi·ªÉu ƒë·ªì
            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${margin.left}, ${chartHeight - margin.bottom + 35})`);

            const legendItems = legend.selectAll(".legend-item")
                .data(spLines)
                .enter()
                .append("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(${i * 150}, 0)`);

            legendItems.append("rect")
                .attr("x", 0)
                .attr("y", -10)
                .attr("width", 12)
                .attr("height", 12)
                .attr("fill", d => color(d.sp));

            legendItems.append("text")
                .attr("x", 18)
                .attr("y", 0)
                .attr("dy", "0.32em")
                .style("font-size", "12px")
                .text(d => d.sp);
        });
    });
</script>


<h2>Ph√¢n ph·ªëi s·ªë ƒë∆°n theo Kh√°ch h√†ng</h2>
<svg id="chart-kh-dist"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    d3.csv("data.csv").then(raw => {
        // ƒê·∫øm s·ªë ƒë∆°n theo t·ª´ng kh√°ch h√†ng
        const ordersByKH = d3.rollup(
            raw,
            v => new Set(v.map(d => d["M√£ ƒë∆°n h√†ng"])).size,
            d => d["M√£ kh√°ch h√†ng"]
        );

        // Gom theo s·ªë ƒë∆°n (v√≠ d·ª• 1 ƒë∆°n: 3456 KH, 2 ƒë∆°n: 789 KH, ...)
        const dist = d3.rollup(
            Array.from(ordersByKH.values()),
            v => v.length, // s·ªë kh√°ch h√†ng
            soDon => soDon // s·ªë ƒë∆°n
        );

        const data = Array.from(dist, ([soDon, soKH]) => ({
            soDon,
            soKH
        })).sort((a, b) => a.soDon - b.soDon);

        const margin = {
            top: 30,
            right: 30,
            bottom: 60,
            left: 80
        };
        const width = 800 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select("#chart-kh-dist")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Tr·ª•c X: s·ªë ƒë∆°n
        const x = d3.scaleBand()
            .domain(data.map(d => d.soDon))
            .range([0, width])
            .padding(0.2);

        // Tr·ª•c Y: s·ªë kh√°ch h√†ng
        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.soKH)])
            .range([height, 0])
            .nice();

        // Tooltip
        const tooltip = d3.select("body").append("div")
            .style("position", "absolute")
            .style("background", "#fff")
            .style("border", "1px solid gray")
            .style("padding", "6px")
            .style("border-radius", "4px")
            .style("pointer-events", "none")
            .style("opacity", 0);

        // V·∫Ω c·ªôt
        g.selectAll(".bar")
            .data(data)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.soDon))
            .attr("y", d => y(d.soKH))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.soKH))
            .attr("fill", "#4e79a7")
            .on("mouseover", (event, d) => {
                tooltip.transition().duration(200).style("opacity", 0.95);
                tooltip.html(
                        `ƒê√£ mua <strong>${d.soDon}</strong> l·∫ßn<br/>
         SL kh√°ch h√†ng: <strong>${d.soKH}</strong>`
                    )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 30) + "px");
            })

        .on("mouseout", () => tooltip.transition().duration(300).style("opacity", 0));

        // Tr·ª•c X
        g.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x));

        // Tr·ª•c Y
        g.append("g")
            .call(d3.axisLeft(y).tickFormat(d3.format(","))
                .ticks(6));

        // Nh√£n tr·ª•c
        svg.append("text")
            .attr("x", (width + margin.left + margin.right) / 2)
            .attr("y", height + margin.top + margin.bottom - 5)
            .attr("text-anchor", "middle")
            .attr("font-size", "14px")
            .text("S·ªë ƒë∆°n h√†ng");

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 15)
            .attr("x", -(height / 2) - margin.top)
            .attr("text-anchor", "middle")
            .attr("font-size", "14px")
            .text("S·ªë kh√°ch h√†ng");
    });
</script>




<h2>Ph√¢n ph·ªëi m·ª©c chi tr·∫£ c·ªßa kh√°ch h√†ng</h2>
<svg id="chart-chi-tra"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    d3.csv("data.csv").then(raw => {
        // B1: T√≠nh t·ªïng chi ti√™u c·ªßa m·ªói kh√°ch h√†ng
        const spendByKH = d3.rollup(
            raw,
            v => d3.sum(v, d => +d["Th√†nh ti·ªÅn"]),
            d => d["M√£ kh√°ch h√†ng"]
        );

        const spends = Array.from(spendByKH.values());

        // B2: X·∫øp v√†o bin (0-3900K, m·ªói 50K)
        const binStep = 50000;
        const maxSpend = 3900000; // 3900K
        const bins = d3.bin()
            .domain([0, maxSpend])
            .thresholds(d3.range(0, maxSpend + binStep, binStep));

        const hist = bins(spends).map(b => ({
            range: [b.x0, b.x1],
            soKH: b.length
        }));

        const margin = {
            top: 30,
            right: 30,
            bottom: 80,
            left: 80
        };
        const width = 1900 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select("#chart-chi-tra")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Tr·ª•c X: kho·∫£ng chi ti√™u
        const x = d3.scaleBand()
            .domain(hist.map(d => d.range[0]))
            .range([0, width])
            .padding(0.1);

        // Tr·ª•c Y: s·ªë kh√°ch h√†ng
        const y = d3.scaleLinear()
            .domain([0, d3.max(hist, d => d.soKH)])
            .nice()
            .range([height, 0]);

        // Tooltip
        const tooltip = d3.select("body").append("div")
            .style("position", "absolute")
            .style("background", "#fff")
            .style("border", "1px solid gray")
            .style("padding", "6px")
            .style("border-radius", "4px")
            .style("pointer-events", "none")
            .style("opacity", 0);

        // V·∫Ω c·ªôt
        g.selectAll(".bar")
            .data(hist)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.range[0]))
            .attr("y", d => y(d.soKH))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.soKH))
            .attr("fill", "#f28e2b")
            .on("mouseover", (event, d) => {
                tooltip.transition().duration(200).style("opacity", 0.95);
                tooltip.html(
                        `Kho·∫£ng chi ti√™u: <strong>${d3.format(",")(d.range[0]/1000)}K ‚Äì ${d3.format(",")(d.range[1]/1000)}K</strong><br/>
                 SL kh√°ch h√†ng: <strong>${d3.format(",")(d.soKH)}</strong>`
                    )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 30) + "px");
            })
            .on("mouseout", () => tooltip.transition().duration(300).style("opacity", 0));

        // Tr·ª•c X
        g.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).tickFormat(d => (d / 1000) + "K"))
            .selectAll("text")
            .attr("transform", "rotate(-45)")
            .style("text-anchor", "end");

        // Tr·ª•c Y
        g.append("g")
            .call(d3.axisLeft(y).tickFormat(d => d >= 1000 ? d / 1000 + "K" : d));

        // Nh√£n tr·ª•c
        svg.append("text")
            .attr("x", (width + margin.left + margin.right) / 2)
            .attr("y", height + margin.top + margin.bottom - 20)
            .attr("text-anchor", "middle")
            .attr("font-size", "14px")
            .text("M·ª©c chi ti√™u (K VND)");

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 20)
            .attr("x", -(height / 2) - margin.top)
            .attr("text-anchor", "middle")
            .attr("font-size", "14px")
            .text("S·ªë kh√°ch h√†ng");
    });
</script>